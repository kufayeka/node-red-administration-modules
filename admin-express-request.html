<!-- admin-express-request.html -->
<script type="text/html" data-template-name="express-request">
    <div class="form-row">
        <label for="node-input-method"><i class="fa fa-tasks"></i> Method</label>
        <select id="node-input-method">
            <option value="get">GET</option>
            <option value="post">POST</option>
            <option value="put">PUT</option>
            <option value="delete">DELETE</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-endpoint"><i class="fa fa-globe"></i> Endpoint</label>
        <input type="text" id="node-input-endpoint" placeholder="/api/example">
    </div>
    <div class="form-row">
        <label for="node-input-schema"><i class="fa fa-code"></i> Request Body Schema (JSON)</label>
        <input id="node-input-schema" type="text" placeholder='{"type": "object", "properties": {"event_id": {"type": "number", "minimum": 1}}, "required": ["event_id"]}'>
        <div id="schema-error" class="red-ui-typedInput-error" style="display: none; color: #d43535;">Invalid JSON schema</div>
    </div>
    <div class="form-row">
        <label for="node-input-validate"><i class="fa fa-check"></i> Validate Request Body</label>
        <input type="checkbox" id="node-input-validate" checked>
    </div>
    <div class="form-row">
        <label for="node-input-server"><i class="fa fa-server"></i> Server</label>
        <input type="text" id="node-input-server">
    </div>
    <div class="form-row">
        <button id="generate-client-code">Generate Client Code</button>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('express-request', {
        category: 'input',
        color: '#c2f0c2',
        defaults: {
            method: { value: 'get' },
            endpoint: { value: '' },
            schema: { value: '{}' },
            validate: { value: false },
            server: { value: '', type: 'express-config' }
        },
        inputs: 0,
        outputs: 1,
        icon: "font-awesome/fa-sign-in",
        label: function () {
            return this.name || `[${this.method}] ` + this.endpoint;
        },
        oneditprepare: function () {
            $("#node-input-schema").typedInput({
                type:"json",
                types:["json"]
            })

            const node = this; // Ambil konteks node saat ini
            $('#generate-client-code').click(function () {
                const server = $("#node-input-server").val() || node.id; // Fallback ke node.id jika server tidak ada

                RED.notify(`Generating client code for: ${server}`, 'info');

                const url = `/express-config/generate-client?expressClientId=${server}`;
                $('#generate-client-code').click(function () {
                    const server = $("#node-input-server").val() || node.id; // Fallback ke node.id

                    RED.notify(`Generating client code for: ${server}`, 'info');

                    const url = `/express-config/generate-client?expressClientId=${server}`;
                    $.get(url, function (clientCode) {
                        const blob = new Blob([clientCode], { type: 'application/javascript' });
                        const link = document.createElement('a');
                        link.href = window.URL.createObjectURL(blob);
                        const now = new Date();
                        const timestamp = now.toISOString().replace(/[:.]/g, '-'); // Misal: 2025-08-05T10-43-21-123Z
                        link.download = `api-client-code-${timestamp}.js`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(link.href);
                        RED.notify('Client code downloaded as event-api-client.js', 'success');
                    }).fail(function (jqXHR, textStatus, errorThrown) {
                        RED.notify(`Failed to generate client code: ${textStatus} - ${errorThrown}`, 'error');
                    });
                });
            });


            // Validasi JSON schema saat input berubah
            $('#node-input-schema').on('input', function () {
                const schema = $(this).val();
                try {
                    JSON.parse(schema);
                    $('#schema-error').hide();
                } catch (e) {
                    $('#schema-error').text('Invalid JSON schema: ' + e.message).show();
                }
            });


            // // Pastikan schema valid saat node disimpan
            // this.on('node-save', function () {
            //     const schema = $('#node-input-schema').val();
            //     try {
            //         JSON.parse(schema);
            //         return true;
            //     } catch (e) {
            //         RED.notify('Invalid JSON schema: ' + e.message, 'error');
            //         return false;
            //     }
            // });
        }
    });
</script>